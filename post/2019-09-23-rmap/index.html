<!DOCTYPE html>



























<html class="not-ready text-sm lg:text-base" lang="zh-cn">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

  
  <title>我在 R 里画地图（一） - BLOG</title>

  
  <meta name="theme-color" />
  
  <meta name="description" content="前言 大约一个月前，接到一个任务：绘制全国的患病率地图，就草草做了一个初版，当时还做了一个 ppt 和组里的小伙伴分享。 直到后来，才知道这种图有一个专业的称呼：choropleth maps，中文名字是分层设色图。 可以看到在 google 中检索 choropleth maps 得到的结果：
单在画图这一方面讲，其实这是一个老生常谈的话题，也有数不胜数的工具和包。但问题的关键在于：绝大多数国外提供的中国地图并不规范。 关于中国地图的规范问题，在姜大伟的知乎专栏 使用中国地图的正确姿势 中有比较翔实的介绍。我也根据此做成了其中一张幻灯片：
所以问题摆在了我们的面前：
找到一张可供使用的规范的中国矢量地图； 根据这张地图绘制我们想要的分层设色图。 提前提醒：本文代码直接复制粘贴不能够运行，请到文末下载分享的全部程序和地图文件！
寻找标准地图 在网络上，使用最多的是一份名为 bou2_4p.shp 的地图矢量文件，这份文件来自哪里已不可考，似乎是 2012 年国家提供的 1：400 万地理信息地图，但是后来又关闭了开放。 这份地图应该是目前问题最少的地图，藏南、台湾、南海诸岛也都存在。但是时间已经来到了 2019 年，这份 12 年的地图是否那么无懈可击呢？
答案是否定的。根据 b 站 up 主“地理人_zxl”的视频 ArcGis更正老式中国基础地理信息数据错误，通过 天地图 和 bou2_4p 的比对，还是可以发现新疆的边界存在一些问题（红线为 bou2_4p，底图为标准地图）：
同时，bou2_4p 的地图也没有澳门特别行政区。通过上面视频中提供的方法，在 ArcGis 中对 bou2_4p 进行修改，就可以得到修正版本的 bou2_4p 了。 这就是我们接下来要使用的标准地图。
使用 R 绘制地图 首先要说明，在我个人使用过的工具和包里面，还是 ArcGis 这种专业 GIS 软件绘制地图最为顺滑快捷。 那为什么要使用 R 语言呢？其实还是出于以下这几个原因：
不只我要出图，别人也要进行地图制作； 免费开源，安装便捷，上手简单； 只需改动患病率数据，运行代码就可出图 再次提醒，以下我不会贴出完整代码，只会贴出一些核心的重点代码。完整的代码会分享在文章末尾。
基础绘图 首先，我们通过 rgdal::readOGR 读取修正过后的中国地图，然后对数据框进行转换，再和患病率数据 da 进行合并。" />
  <meta name="author" content="" />
  

  
  
  
  
  
  
  <link rel="preload stylesheet" as="style" href="https://xzywisdili.com/main.min.css" />

  
  <script
    defer
    src="https://xzywisdili.com/highlight.min.js"
    onload="hljs.initHighlightingOnLoad();"
  ></script>
  

  
  <link
    rel="preload"
    as="image"
    href="https://xzywisdili.com/theme.%7B%7B%20if%20site.Params.monoDarkIcon%20%7D%7Dsvg%7B%7B%20else%20%7D%7Dpng%7B%7B%20end%20%7D%7D"
  />

  
  
  
  <link rel="preload" as="image" href="https://pic.stackoverflow.wiki/uploadImages/118/247/190/255/2022/07/28/18/53/8071d74a-1971-4d71-98c5-95575efef90f.svg" />
  
  

  
  <link rel="preload" as="image" href="https://xzywisdili.com/twitter.svg" />
  
  <link rel="preload" as="image" href="https://xzywisdili.com/github.svg" />
  

  
  <link rel="icon" href="https://xzywisdili.com/favicon.ico" />
  <link rel="apple-touch-icon" href="https://xzywisdili.com/apple-touch-icon.png" />

  
  <meta name="generator" content="Hugo 0.101.0" />

  
  

  
  
  
  
  
  
  
  
  
  <meta property="og:title" content="我在 R 里画地图（一）" />
<meta property="og:description" content="前言 大约一个月前，接到一个任务：绘制全国的患病率地图，就草草做了一个初版，当时还做了一个 ppt 和组里的小伙伴分享。 直到后来，才知道这种图有一个专业的称呼：choropleth maps，中文名字是分层设色图。 可以看到在 google 中检索 choropleth maps 得到的结果：
单在画图这一方面讲，其实这是一个老生常谈的话题，也有数不胜数的工具和包。但问题的关键在于：绝大多数国外提供的中国地图并不规范。 关于中国地图的规范问题，在姜大伟的知乎专栏 使用中国地图的正确姿势 中有比较翔实的介绍。我也根据此做成了其中一张幻灯片：
所以问题摆在了我们的面前：
找到一张可供使用的规范的中国矢量地图； 根据这张地图绘制我们想要的分层设色图。 提前提醒：本文代码直接复制粘贴不能够运行，请到文末下载分享的全部程序和地图文件！
寻找标准地图 在网络上，使用最多的是一份名为 bou2_4p.shp 的地图矢量文件，这份文件来自哪里已不可考，似乎是 2012 年国家提供的 1：400 万地理信息地图，但是后来又关闭了开放。 这份地图应该是目前问题最少的地图，藏南、台湾、南海诸岛也都存在。但是时间已经来到了 2019 年，这份 12 年的地图是否那么无懈可击呢？
答案是否定的。根据 b 站 up 主“地理人_zxl”的视频 ArcGis更正老式中国基础地理信息数据错误，通过 天地图 和 bou2_4p 的比对，还是可以发现新疆的边界存在一些问题（红线为 bou2_4p，底图为标准地图）：
同时，bou2_4p 的地图也没有澳门特别行政区。通过上面视频中提供的方法，在 ArcGis 中对 bou2_4p 进行修改，就可以得到修正版本的 bou2_4p 了。 这就是我们接下来要使用的标准地图。
使用 R 绘制地图 首先要说明，在我个人使用过的工具和包里面，还是 ArcGis 这种专业 GIS 软件绘制地图最为顺滑快捷。 那为什么要使用 R 语言呢？其实还是出于以下这几个原因：
不只我要出图，别人也要进行地图制作； 免费开源，安装便捷，上手简单； 只需改动患病率数据，运行代码就可出图 再次提醒，以下我不会贴出完整代码，只会贴出一些核心的重点代码。完整的代码会分享在文章末尾。
基础绘图 首先，我们通过 rgdal::readOGR 读取修正过后的中国地图，然后对数据框进行转换，再和患病率数据 da 进行合并。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://xzywisdili.com/post/2019-09-23-rmap/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2019-09-23T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-09-23T00:00:00+00:00" />


  
  <meta itemprop="name" content="我在 R 里画地图（一）">
<meta itemprop="description" content="前言 大约一个月前，接到一个任务：绘制全国的患病率地图，就草草做了一个初版，当时还做了一个 ppt 和组里的小伙伴分享。 直到后来，才知道这种图有一个专业的称呼：choropleth maps，中文名字是分层设色图。 可以看到在 google 中检索 choropleth maps 得到的结果：
单在画图这一方面讲，其实这是一个老生常谈的话题，也有数不胜数的工具和包。但问题的关键在于：绝大多数国外提供的中国地图并不规范。 关于中国地图的规范问题，在姜大伟的知乎专栏 使用中国地图的正确姿势 中有比较翔实的介绍。我也根据此做成了其中一张幻灯片：
所以问题摆在了我们的面前：
找到一张可供使用的规范的中国矢量地图； 根据这张地图绘制我们想要的分层设色图。 提前提醒：本文代码直接复制粘贴不能够运行，请到文末下载分享的全部程序和地图文件！
寻找标准地图 在网络上，使用最多的是一份名为 bou2_4p.shp 的地图矢量文件，这份文件来自哪里已不可考，似乎是 2012 年国家提供的 1：400 万地理信息地图，但是后来又关闭了开放。 这份地图应该是目前问题最少的地图，藏南、台湾、南海诸岛也都存在。但是时间已经来到了 2019 年，这份 12 年的地图是否那么无懈可击呢？
答案是否定的。根据 b 站 up 主“地理人_zxl”的视频 ArcGis更正老式中国基础地理信息数据错误，通过 天地图 和 bou2_4p 的比对，还是可以发现新疆的边界存在一些问题（红线为 bou2_4p，底图为标准地图）：
同时，bou2_4p 的地图也没有澳门特别行政区。通过上面视频中提供的方法，在 ArcGis 中对 bou2_4p 进行修改，就可以得到修正版本的 bou2_4p 了。 这就是我们接下来要使用的标准地图。
使用 R 绘制地图 首先要说明，在我个人使用过的工具和包里面，还是 ArcGis 这种专业 GIS 软件绘制地图最为顺滑快捷。 那为什么要使用 R 语言呢？其实还是出于以下这几个原因：
不只我要出图，别人也要进行地图制作； 免费开源，安装便捷，上手简单； 只需改动患病率数据，运行代码就可出图 再次提醒，以下我不会贴出完整代码，只会贴出一些核心的重点代码。完整的代码会分享在文章末尾。
基础绘图 首先，我们通过 rgdal::readOGR 读取修正过后的中国地图，然后对数据框进行转换，再和患病率数据 da 进行合并。"><meta itemprop="datePublished" content="2019-09-23T00:00:00+00:00" />
<meta itemprop="dateModified" content="2019-09-23T00:00:00+00:00" />
<meta itemprop="wordCount" content="308">
<meta itemprop="keywords" content="R 语言,可视化," />
  
  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="我在 R 里画地图（一）"/>
<meta name="twitter:description" content="前言 大约一个月前，接到一个任务：绘制全国的患病率地图，就草草做了一个初版，当时还做了一个 ppt 和组里的小伙伴分享。 直到后来，才知道这种图有一个专业的称呼：choropleth maps，中文名字是分层设色图。 可以看到在 google 中检索 choropleth maps 得到的结果：
单在画图这一方面讲，其实这是一个老生常谈的话题，也有数不胜数的工具和包。但问题的关键在于：绝大多数国外提供的中国地图并不规范。 关于中国地图的规范问题，在姜大伟的知乎专栏 使用中国地图的正确姿势 中有比较翔实的介绍。我也根据此做成了其中一张幻灯片：
所以问题摆在了我们的面前：
找到一张可供使用的规范的中国矢量地图； 根据这张地图绘制我们想要的分层设色图。 提前提醒：本文代码直接复制粘贴不能够运行，请到文末下载分享的全部程序和地图文件！
寻找标准地图 在网络上，使用最多的是一份名为 bou2_4p.shp 的地图矢量文件，这份文件来自哪里已不可考，似乎是 2012 年国家提供的 1：400 万地理信息地图，但是后来又关闭了开放。 这份地图应该是目前问题最少的地图，藏南、台湾、南海诸岛也都存在。但是时间已经来到了 2019 年，这份 12 年的地图是否那么无懈可击呢？
答案是否定的。根据 b 站 up 主“地理人_zxl”的视频 ArcGis更正老式中国基础地理信息数据错误，通过 天地图 和 bou2_4p 的比对，还是可以发现新疆的边界存在一些问题（红线为 bou2_4p，底图为标准地图）：
同时，bou2_4p 的地图也没有澳门特别行政区。通过上面视频中提供的方法，在 ArcGis 中对 bou2_4p 进行修改，就可以得到修正版本的 bou2_4p 了。 这就是我们接下来要使用的标准地图。
使用 R 绘制地图 首先要说明，在我个人使用过的工具和包里面，还是 ArcGis 这种专业 GIS 软件绘制地图最为顺滑快捷。 那为什么要使用 R 语言呢？其实还是出于以下这几个原因：
不只我要出图，别人也要进行地图制作； 免费开源，安装便捷，上手简单； 只需改动患病率数据，运行代码就可出图 再次提醒，以下我不会贴出完整代码，只会贴出一些核心的重点代码。完整的代码会分享在文章末尾。
基础绘图 首先，我们通过 rgdal::readOGR 读取修正过后的中国地图，然后对数据框进行转换，再和患病率数据 da 进行合并。"/>

  
  
</head>

  <body class="text-black duration-200 ease-out dark:text-white">
    <header class="mx-auto flex h-[5rem] max-w-3xl px-8 lg:justify-center">
  <div class="relative z-50 mr-auto flex items-center">
    <a class="-translate-x-[1px] -translate-y-0.5 text-3xl font-bold" href="https://xzywisdili.com/"
      >BLOG</a
    >
    <a
      class="btn-dark ml-6 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.png)_left_center/_auto_theme('spacing.6')_no-repeat] [transition:_background-position_0.4s_steps(5)] dark:[background-position:right]"
    ></a>
  </div>

  <a
    class="btn-menu relative z-50 -mr-8 flex h-[5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden"
  ></a>

  <script>
    const metaTheme = document.querySelector('meta[name="theme-color"]');
    const htmlClass = document.documentElement.classList;
    setTimeout(() => htmlClass.remove('not-ready'), 10);

    const setDark = (newDark) => {
      metaTheme.setAttribute('content', newDark ? '#000' : '#fbfbfb');
      htmlClass[newDark ? 'add' : 'remove']('dark');
      localStorage.setItem('dark', newDark);
    };

    
    const darkScheme = window.matchMedia('(prefers-color-scheme: dark)');
    const darkVal = localStorage.getItem('dark');
    setDark(darkVal ? darkVal === 'true' : darkScheme.matches);

    
    darkScheme.addEventListener('change', (event) => {
      setDark(event.matches);
    });

    
    const btnDark = document.querySelector('.btn-dark');
    btnDark.addEventListener('click', () => {
      setDark(localStorage.getItem('dark') !== 'true');
    });

    
    const btnMenu = document.querySelector('.btn-menu');
    btnMenu.addEventListener('click', () => {
      htmlClass.toggle('open');
    });
  </script>

  <div
    class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full select-none flex-col justify-center pb-16 duration-200 dark:bg-black lg:static lg:h-auto lg:flex-row lg:!bg-transparent lg:pb-0 lg:transition-none"
  >
    
    

    
    <nav
      class="mt-12 flex justify-center space-x-10 dark:invert lg:mt-0 lg:ml-12 lg:items-center lg:space-x-6"
    >
      
      <a
        class="h-8 w-8 [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./twitter.svg)"
        href=" https://twitter.com/xzywisdili "
        target="_blank"
      ></a>
      
      <a
        class="h-8 w-8 [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./github.svg)"
        href=" https://github.com/github.com/xzywisdili "
        target="_blank"
      ></a>
      
    </nav>
    
  </div>
</header>


    <main
      class="prose prose-neutral relative mx-auto min-h-[calc(100%-10rem)] max-w-3xl px-8 pt-20 pb-32 dark:prose-invert"
    >
      

<article>
  <header class="mb-20">
    <h1 class="!my-0 pb-2.5">我在 R 里画地图（一）</h1>

    
    <div class="text-sm opacity-60">
      
      <time>Sep 23, 2019</time>
      
      
    </div>
    
  </header>

  <section><h2 id="前言">前言</h2>
<p>大约一个月前，接到一个任务：绘制全国的患病率地图，就草草做了一个初版，当时还做了一个 ppt 和组里的小伙伴分享。
直到后来，才知道这种图有一个专业的称呼：<a href="https://en.wikipedia.org/wiki/Choropleth_map">choropleth maps</a>，中文名字是<strong>分层设色图</strong>。
可以看到在 google 中检索 choropleth maps 得到的结果：</p>
<p><img src="https://i.loli.net/2019/09/23/PF16SbHG8RVUdO9.jpg" alt=""></p>
<p>单在画图这一方面讲，其实这是一个老生常谈的话题，也有数不胜数的工具和包。但问题的关键在于：绝大多数国外提供的中国地图并不规范。
关于中国地图的规范问题，在姜大伟的知乎专栏 <a href="https://zhuanlan.zhihu.com/p/25634886">使用中国地图的正确姿势</a> 中有比较翔实的介绍。我也根据此做成了其中一张幻灯片：</p>
<p><img src="https://i.loli.net/2019/09/23/6OYLZTwA9tsuMiQ.jpg" alt=""></p>
<p>所以问题摆在了我们的面前：</p>
<ol>
<li>找到一张可供使用的规范的中国矢量地图；</li>
<li>根据这张地图绘制我们想要的分层设色图。</li>
</ol>
<p><strong>提前提醒：本文代码直接复制粘贴不能够运行，请到文末下载分享的全部程序和地图文件！</strong></p>
<h2 id="寻找标准地图">寻找标准地图</h2>
<p>在网络上，使用最多的是一份名为 <strong>bou2_4p.shp</strong> 的地图矢量文件，这份文件来自哪里已不可考，似乎是 2012 年国家提供的 1：400 万地理信息地图，但是后来又关闭了开放。
这份地图应该是目前问题最少的地图，藏南、台湾、南海诸岛也都存在。但是时间已经来到了 2019 年，这份 12 年的地图是否那么无懈可击呢？</p>
<p>答案是否定的。根据 b 站 up 主“地理人_zxl”的视频 <a href="https://www.bilibili.com/video/av63299343">ArcGis更正老式中国基础地理信息数据错误</a>，通过 <a href="http://www.tianditu.gov.cn/">天地图</a>
和 bou2_4p 的比对，还是可以发现新疆的边界存在一些问题（红线为 bou2_4p，底图为标准地图）：</p>
<p><img src="https://i.loli.net/2019/09/23/DSTahEbdA2XefVO.jpg" alt=""></p>
<p>同时，bou2_4p 的地图也没有澳门特别行政区。通过上面视频中提供的方法，在 ArcGis 中对 bou2_4p 进行修改，就可以得到修正版本的 bou2_4p 了。
这就是我们接下来要使用的标准地图。</p>
<h2 id="使用-r-绘制地图">使用 R 绘制地图</h2>
<p>首先要说明，在我个人使用过的工具和包里面，还是 ArcGis 这种专业 GIS 软件绘制地图最为顺滑快捷。
那为什么要使用 R 语言呢？其实还是出于以下这几个原因：</p>
<ul>
<li>不只我要出图，别人也要进行地图制作；</li>
<li>免费开源，安装便捷，上手简单；</li>
<li>只需改动患病率数据，运行代码就可出图</li>
</ul>
<p>再次提醒，以下我不会贴出完整代码，只会贴出一些核心的重点代码。完整的代码会分享在文章末尾。</p>
<h3 id="基础绘图">基础绘图</h3>
<p>首先，我们通过 <code>rgdal::readOGR</code> 读取修正过后的中国地图，然后对数据框进行转换，再和患病率数据 <code>da</code> 进行合并。</p>
<p>患病率数据 <code>da</code> 长什么样子呢？你一看便懂：</p>
<table>
<thead>
<tr>
<th>NAME</th>
<th>rate</th>
</tr>
</thead>
<tbody>
<tr>
<td>安徽省</td>
<td>15.89</td>
</tr>
<tr>
<td>北京市</td>
<td>12.85</td>
</tr>
<tr>
<td>福建省</td>
<td>15.14</td>
</tr>
<tr>
<td>黑龙江省</td>
<td>NA</td>
</tr>
</tbody>
</table>
<p>这里的患病率数据中用 <code>rate</code> 写明了每个省的患病率大小。然后通过 <code>ggplot</code> 绘制出我们需要的基础制图。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span>china_map <span style="color:#f92672">&lt;-</span> rgdal<span style="color:#f92672">::</span><span style="color:#a6e22e">readOGR</span>(<span style="color:#e6db74">&#34;map//bou2_4p.shp&#34;</span>, use_iconv <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>, encoding <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;UTF-8&#34;</span>)
</span></span><span style="display:flex;"><span>xdata <span style="color:#f92672">&lt;-</span> china_map<span style="color:#f92672">@</span>data 
</span></span><span style="display:flex;"><span>xs <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">data.frame</span>(xdata, id<span style="color:#f92672">=</span><span style="color:#a6e22e">as.character</span>(<span style="color:#a6e22e">seq</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">924</span>))) 
</span></span><span style="display:flex;"><span>china_map1 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">fortify</span>(china_map) 
</span></span><span style="display:flex;"><span>china_map_data <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">left_join</span>(china_map1, xs, type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;full&#34;</span>)
</span></span><span style="display:flex;"><span>china_data <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">left_join</span>(china_map_data, da, by<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;NAME&#39;</span>, type<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;full&#34;</span>) 
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ggplot</span>(china_data, <span style="color:#a6e22e">aes</span>(long, lat))<span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">geom_polygon</span>(<span style="color:#a6e22e">aes</span>(group<span style="color:#f92672">=</span>group, fill <span style="color:#f92672">=</span> rate), color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;white&#39;</span>, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.25</span>)
</span></span></code></pre></div><p>我们可以在这一步对 x 轴和 y 轴的范围进行裁剪，修改地理坐标投影系，并修改绘图主题，隐藏 x 轴和 y 轴等等。下一步再进行进一步的美化。</p>
<p><img src="https://i.loli.net/2019/09/23/JKaRDHenAuo1iXV.jpg" alt=""></p>
<h3 id="美化底图">美化底图</h3>
<p>接下来就是进行地图的进一步美化，比如我们想要更改色阶的颜色。这里的 <code>p1</code> 就是我们上一步保存的底图。
第二步的核心在于 <code>scale_fill_gradientn</code>，可以指定无限数目的渐变色了。
而 <code>na.value</code> 则是指定缺失值省份的颜色。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span>p2 <span style="color:#f92672">&lt;-</span> p1 <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">scale_fill_gradientn</span>(
</span></span><span style="display:flex;"><span>    colours<span style="color:#f92672">=</span><span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;#4C79B0&#34;</span>, <span style="color:#e6db74">&#34;#9FD2AE&#34;</span>, <span style="color:#e6db74">&#34;#F4C4B2&#34;</span>, <span style="color:#e6db74">&#34;#BE1E56&#34;</span>),
</span></span><span style="display:flex;"><span>    na.value <span style="color:#f92672">=</span> ’<span style="color:#75715e">#D3D3D3&#39;</span>
</span></span><span style="display:flex;"><span>  )
</span></span><span style="display:flex;"><span>p2
</span></span></code></pre></div><p><img src="https://tva1.sinaimg.cn/large/006y8mN6gy1g79r767fk6j31by0ts40r.jpg" alt=""></p>
<p>顺带一提，想要选取好看的颜色，可以试试在 google 图片里面搜索 choropleth map。
如果看到顺眼的颜色，可以直接得到色彩的 hex 值复制到自己的图里。</p>
<h3 id="绘制九段线">绘制九段线</h3>
<p>九段线的地图文件来自 <code>l9.shp</code>，这里我们想要把九段线绘制在整个地图的右下角，并且小图中出现的广东等省份也是染好色的。
思路就是把整张图和九段线全部画出来，再通过经纬度截取出我们想要的那部分：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span>l9 <span style="color:#f92672">&lt;-</span> rgdal<span style="color:#f92672">::</span><span style="color:#a6e22e">readOGR</span>(<span style="color:#e6db74">&#39;map\\l9.shp&#39;</span>)
</span></span><span style="display:flex;"><span>l91 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">fortify</span>(l9)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>china_map <span style="color:#f92672">&lt;-</span> rgdal<span style="color:#f92672">::</span><span style="color:#a6e22e">readOGR</span>(<span style="color:#e6db74">&#34;map//bou2_4p.shp&#34;</span>, use_iconv <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>, encoding <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;UTF-8&#34;</span>)
</span></span><span style="display:flex;"><span>xdata <span style="color:#f92672">&lt;-</span> china_map<span style="color:#f92672">@</span>data 
</span></span><span style="display:flex;"><span>xs <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">data.frame</span>(xdata, id<span style="color:#f92672">=</span><span style="color:#a6e22e">as.character</span>(<span style="color:#a6e22e">seq</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">924</span>))) 
</span></span><span style="display:flex;"><span>china_map1 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">fortify</span>(china_map) 
</span></span><span style="display:flex;"><span>china_map_data <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">left_join</span>(china_map1, xs, type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;full&#34;</span>)
</span></span><span style="display:flex;"><span>china_data <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">left_join</span>(china_map_data, da, by<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;NAME&#39;</span>, type<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;full&#34;</span>) 
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>p9 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">ggplot</span>(china_data, <span style="color:#a6e22e">aes</span>(long, lat))<span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">geom_polygon</span>(<span style="color:#a6e22e">aes</span>(group<span style="color:#f92672">=</span>group, fill <span style="color:#f92672">=</span> rate), color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;white&#34;</span>, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.25</span>) <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">coord_map</span>(<span style="color:#e6db74">&#34;albers&#34;</span>, lat0<span style="color:#f92672">=</span><span style="color:#ae81ff">27</span>, lat1<span style="color:#f92672">=</span><span style="color:#ae81ff">45</span>) <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">scale_fill_gradientn</span>(
</span></span><span style="display:flex;"><span>    colours<span style="color:#f92672">=</span>plot_color,
</span></span><span style="display:flex;"><span>    guide <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;none&#34;</span>
</span></span><span style="display:flex;"><span>  ) <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">geom_line</span>(data<span style="color:#f92672">=</span>l91, <span style="color:#a6e22e">aes</span>(x<span style="color:#f92672">=</span>long, y<span style="color:#f92672">=</span>lat, group<span style="color:#f92672">=</span>group)) <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">coord_cartesian</span>(xlim<span style="color:#f92672">=</span><span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">105</span>,<span style="color:#ae81ff">125</span>),ylim<span style="color:#f92672">=</span><span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">30</span>))
</span></span></code></pre></div><p>得到九段线小图后，再通过 <code>grid</code> 包把这个小图放置在原图的右下角。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span><span style="color:#a6e22e">library</span>(grid)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>vie <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">viewport</span>(width<span style="color:#f92672">=</span><span style="color:#ae81ff">0.225</span>, height<span style="color:#f92672">=</span><span style="color:#ae81ff">0.15</span>, x<span style="color:#f92672">=</span><span style="color:#ae81ff">0.78</span>, y<span style="color:#f92672">=</span><span style="color:#ae81ff">0.15</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">print</span>(p9) 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">print</span>(l9, vp<span style="color:#f92672">=</span>vie) 
</span></span></code></pre></div><p>这样，就达到了如下图这样的效果：</p>
<p><img src="https://tva1.sinaimg.cn/large/006y8mN6gy1g79rfarviwj31bw0tgjtr.jpg" alt=""></p>
<h3 id="添加省份名字标签">添加省份名字标签</h3>
<p>在第一个版本做好之后，老板说让我可以加上省份名称的英文标签。
我想，不如就再增加一个添加省份名称标签的功能，中英文都整上。
这里，如果熟悉 <code>ggplot</code> 的朋友，应该会觉得很简单。
只要准备好了两份数据文件，分别是 <code>cn_text</code> 和 <code>en_text</code>，里面记录每个省的标签名字和标签的位置。
然后使用 <code>geom_text</code> 即可完成：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-R" data-lang="R"><span style="display:flex;"><span>text_da <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">read.csv</span>(<span style="color:#e6db74">&#34;map\\cn_text.csv&#34;</span>)
</span></span><span style="display:flex;"><span>p3 <span style="color:#f92672">&lt;-</span> p2 <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">geom_text</span>(data<span style="color:#f92672">=</span>text_da, <span style="color:#a6e22e">aes</span>(label<span style="color:#f92672">=</span>text))
</span></span></code></pre></div><p>在 <code>geom_text</code> 里面，修改文字的字体，大小，颜色自然也不在话下。
除此之外，只要把 <code>geom_text</code> 替换成 <code>geom_shadowtext</code>，就可以使用带白边的标签，效果如下：</p>
<p><img src="https://tva1.sinaimg.cn/large/006y8mN6gy1g79rg0c73zj31b80tgdir.jpg" alt=""></p>
<p>在我的破电脑上，如果单次开始运行整个绘图程序，到出图保存，大概需要 10s 左右。
这可能是一个劣势，当然也不是不能接受的。</p>
<h2 id="后记">后记</h2>
<p>想来这篇也拖了很久的时间，着实不太应该。
本来想把所有内容写在一篇内容中，但是想想我也不易写，读者也不易读，实在是不太好。
于是我只把最最核心的内容记录在博客中，主要是陈述思路，而删减了很多内容。</p>
<p>这里，我把所有地图文件，程序和说明文档打包在了<a href="https://pan.baidu.com/s/1U3qcPwJf-puUDBsovuEeBw">这里</a>。
我已经尽量做到简单易用，这个系列的第二篇就写写怎么画插值热力图。
之后我还会继续研究绘制地图的相关方法，有新的技巧，感想和技能还会更新。</p>
</section>

  
  
  <footer class="mt-12 flex flex-wrap">
     
    <a
      class="mr-1.5 mb-1.5 rounded-lg bg-black/[3%] px-5 py-2 no-underline dark:bg-white/[8%]"
      href="https://xzywisdili.com/tags/r-%E8%AF%AD%E8%A8%80"
      >R 语言</a
    >
     
    <a
      class="mr-1.5 mb-1.5 rounded-lg bg-black/[3%] px-5 py-2 no-underline dark:bg-white/[8%]"
      href="https://xzywisdili.com/tags/%E5%8F%AF%E8%A7%86%E5%8C%96"
      >可视化</a
    >
    
  </footer>
  

  
  
  
  <nav class="mt-24 flex rounded-lg bg-black/[3%] text-lg dark:bg-white/[8%]">
    
    <a class="flex w-1/2 items-center p-6 pr-3 no-underline" href="https://xzywisdili.com/post/2019-09-24-weeknote/"
      ><span class="mr-1.5">←</span><span>一周总结（9.16-9.22）</span></a
    >
    
    
    <a
      class="ml-auto flex w-1/2 items-center justify-end p-6 pl-3 no-underline"
      href="https://xzywisdili.com/post/2019-09-16-weeknote/"
      ><span>这一周（9.9-9.15）</span><span class="ml-1.5">→</span></a
    >
    
  </nav>
  

  
  
</article>


    </main>

    <footer class="opaco mx-auto flex h-[5rem] max-w-3xl items-center px-8 text-[0.9em] opacity-60">
  <div class="mr-auto">
    &copy; 2022
    <a class="link" href="https://xzywisdili.com/">BLOG</a>
  </div>
  <a class="link mx-6" href="https://gohugo.io/" rel="noopener" target="_blank">Powered by Hugo️️</a
  >️
  <a class="link" href="https://github.com/nanxiaobei/hugo-paper" rel="noopener" target="_blank"
    >▷ Paper 6</a
  >
</footer>

  </body>
</html>
